---
apiVersion: v1
data:
  password: YWRtaW4=
  user: YWRtaW4=
kind: Secret
metadata:
  labels:
    app: dkube-prometheus-grafana
    ksonnet.io/component: monitoring
  name: dkube-prometheus-grafana
  namespace: dkube
type: Opaque

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  labels:
  name: dkube-prometheus-clusterrolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: dkube-prometheus-clusterrole
subjects:
- kind: ServiceAccount
  name: dkube-prometheus
  namespace: dkube

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: dkube-prometheus-clusterrole
rules:
- apiGroups:
  - ""
  resources:
  - nodes
  - services
  - endpoints
  - pods
  - nodes/proxy
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - ""
  resources:
  - configmaps
  verbs:
  - get
- nonResourceURLs:
  - /metrics
  verbs:
  - get
- apiGroups:
  - extensions
  resources:
  - ingresses
  verbs: ["get", "list", "watch"]

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: dkube-prometheus
  namespace: dkube

---
apiVersion: v1
data:
  prometheus.rules: |-
    groups:
    - name: dkube alert
      rules:
      - alert: High Pod Memory
        expr: sum(container_memory_usage_bytes) > 1
        for: 1m
        labels:
          severity: slack
        annotations:
          summary: High Memory Usage
  prometheus.yml: |-
    global:
      scrape_interval: 30s
      evaluation_interval: 30s
    remote_read: REMOTE_READ_CONFIG
    remote_write: REMOTE_WRITE_CONFIG
    rule_files:
      - /prometheus/rules/*.yml
    alerting:
      alertmanagers:
      - static_configs:
        - targets:
          - dkube-alertmanager.dkube
    scrape_configs:
    - job_name: 'kubernetes-cadvisor'
 
      scheme: https
 
      tls_config:
        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
 
      kubernetes_sd_configs:
      - role: node
 
      relabel_configs:
      - action: labelmap
        regex: __meta_kubernetes_node_label_(.+)
      - target_label: __address__
        replacement: kubernetes.default.svc:443
      - source_labels: [__meta_kubernetes_node_name]
        regex: (.+)
        target_label: __metrics_path__
        replacement: /api/v1/nodes/${1}/proxy/metrics/cadvisor

    # scrape config for service endpoints.
    - job_name: 'dkube-service-endpoints'
      kubernetes_sd_configs:
      - role: endpoints
      relabel_configs:
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_dkube_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]
        action: replace
        target_label: __scheme__
        regex: (https?)
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
      - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]
        action: replace
        target_label: __address__
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: $1:$2
      - action: labelmap
        regex: __meta_kubernetes_service_label_(.+)
      - source_labels: [__meta_kubernetes_namespace]
        action: replace
        target_label: kubernetes_namespace
      - source_labels: [__meta_kubernetes_service_name]
        action: replace
        target_label: kubernetes_name
    - job_name: kfserving-monitoring
      honor_timestamps: true
      scrape_timeout: 10s
      metrics_path: /metrics
      scheme: http
      follow_redirects: true
      relabel_configs:
      - source_labels: [__meta_kubernetes_service_label_networking_internal_knative_dev_serviceType]
        separator: ;
        regex: Private
        replacement: $1
        action: keep
      - source_labels: [__meta_kubernetes_endpoint_port_name]
        separator: ;
        regex: http-usermetric
        replacement: $1
        action: keep
      - source_labels: [__meta_kubernetes_namespace]
        separator: ;
        regex: (.*)
        target_label: namespace
        replacement: $1
        action: replace
      - source_labels: [__meta_kubernetes_pod_name]
        separator: ;
        regex: (.*)
        target_label: pod
        replacement: $1
        action: replace
      - source_labels: [__meta_kubernetes_pod_container_name]
        separator: ;
        regex: (.*)
        target_label: container
        replacement: $1
        action: replace
      - source_labels: [__meta_kubernetes_pod_label_jobname]
        separator: ;
        regex: (.*)
        target_label: deployment
        replacement: ${1}
        action: replace
      - source_labels: [__meta_kubernetes_pod_label_component]
        separator: ;
        regex: (.*)
        target_label: component
        replacement: ${1}
        action: replace
      kubernetes_sd_configs:
      - role: endpoints
        kubeconfig_file: ""
        follow_redirects: true

kind: ConfigMap
metadata:
  name: dkube-prometheus-config
  namespace: dkube

---
apiVersion: v1
kind: Service
metadata:
  annotations:
    prometheus.io/port: "9111"
    prometheus.io/dkube_scrape: "true"
  labels:
    app: dkube-node-exporter
  name: dkube-node-exporter
  namespace: dkube
spec:
  ports:
  - name: metrics
    port: 9111
    protocol: TCP
    targetPort: metrics
  selector:
    app: dkube-node-exporter
  sessionAffinity: None
  type: ClusterIP

---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  labels:
    app: dkube-node-exporter
  name: dkube-node-exporter
  namespace: dkube
spec:
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: dkube-node-exporter
  template:
    metadata:
      labels:
        app: dkube-node-exporter
    spec:
      tolerations:
        - operator: "Exists"
      containers:
      - args:
        - --web.listen-address=0.0.0.0:9111
        - --path.procfs=/host/proc
        - --path.sysfs=/host/sys
        image: quay.io/prometheus/node-exporter:v0.15.2
        imagePullPolicy: IfNotPresent
        name: node-exporter
        ports:
        - containerPort: 9111
          hostPort: 9111
          name: metrics
          protocol: TCP
        resources:
          limits:
            cpu: 200m
            memory: 50Mi
          requests:
            cpu: 100m
            memory: 30Mi
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /host/proc
          name: proc
          readOnly: true
        - mountPath: /host/sys
          name: sys
          readOnly: true
      dnsPolicy: ClusterFirst
      hostNetwork: true
      hostPID: true
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext: {}
      serviceAccount: dkube-prometheus
      serviceAccountName: dkube-prometheus
      terminationGracePeriodSeconds: 30
      tolerations:
      - effect: NoSchedule
        operator: Exists
      volumes:
      - hostPath:
          path: /proc
          type: ""
        name: proc
      - hostPath:
          path: /sys
          type: ""
        name: sys
  # templateGeneration: 1
  updateStrategy:
    type: OnDelete

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  labels:
    app: dkube-state-exporter
  name: dkube-state-exporter
  namespace: dkube
rules:
- apiGroups:
  - ""
  resources:
  - pods
  verbs:
  - get
- apiGroups:
  - extensions
  resourceNames:
  - dkube-state-exporter
  resources:
  - deployments
  verbs:
  - get
  - update

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    app: dkube-state-exporter
  name: dkube-state-exporter
rules:
- apiGroups:
  - ""
  resources:
  - namespaces
  - nodes
  - pods
  - services
  - resourcequotas
  - replicationcontrollers
  - limitranges
  - persistentvolumeclaims
  - persistentvolumes
  - endpoints
  verbs:
  - list
  - watch
- apiGroups:
  - extensions
  resources:
  - daemonsets
  - deployments
  - replicasets
  verbs:
  - list
  - watch
- apiGroups:
  - apps
  resources:
  - statefulsets
  verbs:
  - list
  - watch
- apiGroups:
  - batch
  resources:
  - cronjobs
  - jobs
  verbs:
  - list
  - watch
- apiGroups:
  - autoscaling
  resources:
  - horizontalpodautoscalers
  verbs:
  - list
  - watch

---
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    app: dkube-state-exporter
  name: dkube-state-exporter
  namespace: dkube

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  labels:
    app: dkube-state-exporter
  name: dkube-state-exporter
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: dkube-state-exporter
subjects:
- kind: ServiceAccount
  name: dkube-state-exporter
  namespace: dkube

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  labels:
    app: dkube-state-exporter
  name: dkube-state-exporter
  namespace: dkube
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: dkube-state-exporter
subjects:
- kind: ServiceAccount
  name: dkube-state-exporter

---
apiVersion: v1
kind: Service
metadata:
  annotations:
    prometheus.io/port: "8080"
    prometheus.io/dkube_scrape: "true"
  labels:
    app: dkube-state-exporter
  name: dkube-state-exporter
  namespace: dkube
spec:
  ports:
  - name: dkube-state-metrics
    port: 80
    protocol: TCP
    targetPort: 8080
  selector:
    app: dkube-exporter-deploy
  sessionAffinity: None
  type: ClusterIP
---
# This service enables/disables deployment metrics polling, export metrics
apiVersion: v1
kind: Service
metadata:
  annotations:
    prometheus.io/port: "8000"
    prometheus.io/dkube_scrape: "true"
  labels:
    app: deployments-exporter
  name: deployments-exporter
  namespace: dkube
spec:
  ports:
  - name: deployment-metrics
    port: 80
    protocol: TCP
    targetPort: 8000
  selector:
    app: dkube-exporter-deploy
  sessionAffinity: None
  type: ClusterIP
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  labels:
    ksonnet.io/component: monitoring
  name: dkube-prometheus-pvc
  namespace: dkube
spec:
  accessModes:
  - ReadWriteMany
  resources:
    requests:
      storage: 50Gi
  storageClassName: ""
  volumeName: dkube-prometheus-pv

---
apiVersion: v1
kind: Service
metadata:
  annotations:
    prometheus.io/dkube_scrape: "true"
    prometheus.io/port: '9090'
  labels:
    app: dkube-prometheus
  name: dkube-prometheus
  namespace: dkube
spec:
  ports:
  - name: http-prometheus
    port: 9090
    protocol: TCP
    targetPort: 9090
  selector:
    app: dkube-prometheus
  sessionAffinity: None
  type: ClusterIP

---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: dkube-alertmanager
  name: dkube-alertmanager
  namespace: dkube
spec:
  ports:
  - name: http-alertmanager
    port: 80
    protocol: TCP
    targetPort: 9093
  selector:
    app: dkube-prometheus
  sessionAffinity: None
  type: ClusterIP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: dkube-prometheus
  name: dkube-prometheus
  namespace: dkube
spec:
  progressDeadlineSeconds: 600
  replicas: 1
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: dkube-prometheus
  strategy:
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: dkube-prometheus
    spec:
      containers:
        - name: prometheus
          image: prom/prometheus:v2.28.1
          args:
            - "--config.file=/etc/prometheus/prometheus.yml"
            - "--storage.tsdb.path=/prometheus/"
            - "--storage.tsdb.retention.time=3650d"
            - "--web.enable-admin-api"
            - "--web.enable-lifecycle"
          ports:
            - containerPort: 9090
          volumeMounts:
            - name: prometheus-config-volume
              mountPath: /etc/prometheus/
            - name: prometheus-storage-volume
              mountPath: /prometheus/
        - name: alertmanager
          image: prom/alertmanager:v0.23.0
          args:
            - "--config.file=/prometheus/alertmanager/alertmanager.yml"
          ports:
            - containerPort: 9093
          volumeMounts:
            - name: prometheus-storage-volume
              mountPath: /prometheus/

      serviceAccount: dkube-prometheus
      serviceAccountName: dkube-prometheus
      volumes:
        - name: prometheus-config-volume
          configMap:
            defaultMode: 420
            name: dkube-prometheus-config
  
        - name: prometheus-storage-volume
          persistentVolumeClaim:
            claimName: dkube-prometheus-pvc

---
apiVersion: v1
data:
  prometheus-datasource.json: |
    {
      "access": "proxy",
      "basicAuth": false,
      "name": "prometheus",
      "type": "prometheus",
      "url": "http://dkube-prometheus:9090"
    }
  monitoring-health-dashboard.json: |-
    {
        "inputs": [{
            "name": "DS_PROMETHEUS",
            "pluginId": "prometheus",
            "type": "datasource",
            "value": "prometheus"
        }],
        "overwrite": true,
        "dashboard": {
            "__inputs": [{
                "description": "",
                "label": "prometheus",
                "name": "DS_PROMETHEUS",
                "pluginId": "prometheus",
                "pluginName": "Prometheus",
                "type": "datasource"
            }],
            "annotations": {
                "list": [
                  {
                    "builtIn": 1,
                    "datasource": "-- Grafana --",
                    "enable": true,
                    "hide": true,
                    "iconColor": "rgba(0, 211, 255, 1)",
                    "name": "Annotations & Alerts",
                    "target": {
                      "limit": 100,
                      "matchAny": false,
                      "tags": [],
                      "type": "dashboard"
                    },
                    "type": "dashboard"
                  }
                ]
              },
              "editable": true,
              "fiscalYearStartMonth": 0,
              "graphTooltip": 0,
              "id": null,
              "iteration": 1648487585091,
              "links": [],
              "liveNow": false,
              "panels": [
                {
                  "aliasColors": {
                    "ALERTS": "super-light-red"
                  },
                  "bars": false,
                  "dashLength": 10,
                  "dashes": false,
                  "datasource": {
                    "uid": "$Source"
                  },
                  "description": "",
                  "fill": 1,
                  "fillGradient": 0,
                  "gridPos": {
                    "h": 7,
                    "w": 12,
                    "x": 0,
                    "y": 0
                  },
                  "hiddenSeries": false,
                  "id": 4,
                  "legend": {
                    "avg": false,
                    "current": false,
                    "max": false,
                    "min": false,
                    "show": true,
                    "total": false,
                    "values": false
                  },
                  "lines": true,
                  "linewidth": 1,
                  "links": [],
                  "nullPointMode": "null",
                  "options": {
                    "alertThreshold": true
                  },
                  "percentage": false,
                  "pluginVersion": "8.4.4",
                  "pointradius": 2,
                  "points": false,
                  "renderer": "flot",
                  "seriesOverrides": [
                    {
                      "$$hashKey": "object:54",
                      "alias": "ALERTS",
                      "fill": 0,
                      "linewidth": 0,
                      "points": true,
                      "yaxis": 2
                    }
                  ],
                  "spaceLength": 10,
                  "stack": false,
                  "steppedLine": false,
                  "targets": [
                    {
                      "datasource": {
                        "uid": "$Source"
                      },
                      "exemplar": true,
                      "expr": "sum(rate(mm_deployment_predictions_total{mm_id=\"$mm_id\"}[$rate_duration])*60) by (response_code_class)",
                      "format": "time_series",
                      "interval": "",
                      "intervalFactor": 1,
                      "legendFormat": "{{response_code_class}}",
                      "refId": "A"
                    },
                    {
                      "datasource": {
                        "uid": "$Source"
                      },
                      "exemplar": true,
                      "expr": "sum(ALERTS{id=\"$mm_id\", type=\"health\", alertstate=\"firing\"})",
                      "hide": false,
                      "interval": "",
                      "legendFormat": "ALERTS",
                      "refId": "B"
                    }
                  ],
                  "thresholds": [],
                  "timeRegions": [
                    {
                      "$$hashKey": "object:269",
                      "colorMode": "background6",
                      "fill": true,
                      "fillColor": "rgba(234, 112, 112, 0.12)",
                      "line": false,
                      "lineColor": "rgba(237, 46, 24, 0.60)",
                      "op": "time"
                    }
                  ],
                  "title": "Prediction Requests rate[1/m]",
                  "tooltip": {
                    "shared": true,
                    "sort": 0,
                    "value_type": "individual"
                  },
                  "type": "graph",
                  "xaxis": {
                    "mode": "time",
                    "show": true,
                    "values": []
                  },
                  "yaxes": [
                    {
                      "$$hashKey": "object:104",
                      "format": "short",
                      "logBase": 1,
                      "min": "0",
                      "show": true
                    },
                    {
                      "$$hashKey": "object:105",
                      "decimals": 0,
                      "format": "short",
                      "label": "ALERTS",
                      "logBase": 1,
                      "min": "0",
                      "show": true
                    }
                  ],
                  "yaxis": {
                    "align": false
                  }
                },
                {
                  "cards": {},
                  "color": {
                    "cardColor": "#b4ff00",
                    "colorScale": "sqrt",
                    "colorScheme": "interpolateSpectral",
                    "exponent": 0.5,
                    "mode": "spectrum"
                  },
                  "dataFormat": "tsbuckets",
                  "datasource": {
                    "uid": "$Source"
                  },
                  "gridPos": {
                    "h": 7,
                    "w": 12,
                    "x": 12,
                    "y": 0
                  },
                  "heatmap": {},
                  "hideZeroBuckets": true,
                  "highlightCards": true,
                  "id": 16,
                  "legend": {
                    "show": true
                  },
                  "links": [],
                  "reverseYBuckets": false,
                  "targets": [
                    {
                      "datasource": {
                        "uid": "$Source"
                      },
                      "exemplar": true,
                      "expr": "sum(rate(mm_deployment_latency_bucket{mm_id=\"$mm_id\"}[$rate_duration])*60) by (le)",
                      "format": "heatmap",
                      "interval": "1m",
                      "intervalFactor": 1,
                      "legendFormat": "{{le}}",
                      "refId": "A"
                    }
                  ],
                  "title": "Deployment Latency, event rate[1/m]",
                  "tooltip": {
                    "show": true,
                    "showHistogram": false
                  },
                  "type": "heatmap",
                  "xAxis": {
                    "show": true
                  },
                  "yAxis": {
                    "format": "ms",
                    "logBase": 1,
                    "show": true
                  },
                  "yBucketBound": "auto"
                },
                {
                  "aliasColors": {},
                  "bars": false,
                  "dashLength": 10,
                  "dashes": false,
                  "datasource": {
                    "uid": "$Source"
                  },
                  "fill": 1,
                  "fillGradient": 0,
                  "gridPos": {
                    "h": 7,
                    "w": 12,
                    "x": 0,
                    "y": 7
                  },
                  "hiddenSeries": false,
                  "id": 14,
                  "legend": {
                    "avg": false,
                    "current": false,
                    "max": false,
                    "min": false,
                    "show": true,
                    "total": false,
                    "values": false
                  },
                  "lines": true,
                  "linewidth": 1,
                  "links": [],
                  "nullPointMode": "null",
                  "options": {
                    "alertThreshold": true
                  },
                  "percentage": false,
                  "pluginVersion": "8.4.4",
                  "pointradius": 5,
                  "points": false,
                  "renderer": "flot",
                  "seriesOverrides": [],
                  "spaceLength": 10,
                  "stack": false,
                  "steppedLine": false,
                  "targets": [
                    {
                      "expr": "(sum(rate(mm_deployment_latency_sum{mm_id='$mm_id'}[$rate_duration]))/sum(rate(mm_deployment_latency_count{mm_id='$mm_id'}[$rate_duration])))",
                      "format": "time_series",
                      "intervalFactor": 1,
                      "legendFormat": "Latency Average",
                      "refId": "A"
                    }
                  ],
                  "thresholds": [],
                  "timeRegions": [],
                  "title": "Latency Average",
                  "tooltip": {
                    "shared": true,
                    "sort": 0,
                    "value_type": "individual"
                  },
                  "type": "graph",
                  "xaxis": {
                    "mode": "time",
                    "show": true,
                    "values": []
                  },
                  "yaxes": [
                    {
                      "$$hashKey": "object:1292",
                      "decimals": 2,
                      "format": "ms",
                      "logBase": 1,
                      "min": "0",
                      "show": true
                    },
                    {
                      "$$hashKey": "object:1293",
                      "format": "short",
                      "logBase": 1,
                      "show": true
                    }
                  ],
                  "yaxis": {
                    "align": false
                  }
                },
                {
                  "aliasColors": {
                    "CPU": "#7EB26D",
                    "Memory": "#EAB839"
                  },
                  "bars": false,
                  "dashLength": 10,
                  "dashes": false,
                  "datasource": {
                    "uid": "$Source"
                  },
                  "fill": 1,
                  "fillGradient": 0,
                  "gridPos": {
                    "h": 7,
                    "w": 12,
                    "x": 12,
                    "y": 7
                  },
                  "hiddenSeries": false,
                  "id": 10,
                  "legend": {
                    "avg": false,
                    "current": false,
                    "max": false,
                    "min": false,
                    "show": true,
                    "total": false,
                    "values": false
                  },
                  "lines": true,
                  "linewidth": 1,
                  "links": [],
                  "nullPointMode": "null",
                  "options": {
                    "alertThreshold": true
                  },
                  "percentage": false,
                  "pluginVersion": "8.4.4",
                  "pointradius": 5,
                  "points": false,
                  "renderer": "flot",
                  "seriesOverrides": [
                    {
                      "$$hashKey": "object:674",
                      "alias": "Memory",
                      "lines": true,
                      "yaxis": 2
                    }
                  ],
                  "spaceLength": 10,
                  "stack": false,
                  "steppedLine": false,
                  "targets": [
                    {
                      "datasource": {
                        "uid": "$Source"
                      },
                      "expr": "sum(rate(mm_deployment_cpu_usage_total{mm_id=\"$mm_id\"}[$rate_duration]))",
                      "format": "time_series",
                      "intervalFactor": 1,
                      "legendFormat": "CPU",
                      "refId": "A"
                    },
                    {
                      "datasource": {
                        "uid": "$Source"
                      },
                      "exemplar": true,
                      "expr": "sum(mm_deployment_memory_usage{mm_id=\"$mm_id\"})",
                      "hide": false,
                      "interval": "",
                      "legendFormat": "Memory",
                      "refId": "B"
                    }
                  ],
                  "thresholds": [],
                  "timeRegions": [],
                  "title": "CPU / Memory",
                  "tooltip": {
                    "shared": true,
                    "sort": 0,
                    "value_type": "individual"
                  },
                  "transformations": [],
                  "type": "graph",
                  "xaxis": {
                    "mode": "time",
                    "show": true,
                    "values": []
                  },
                  "yaxes": [
                    {
                      "$$hashKey": "object:520",
                      "decimals": 2,
                      "format": "percentunit",
                      "label": "",
                      "logBase": 1,
                      "min": "0",
                      "show": true
                    },
                    {
                      "$$hashKey": "object:521",
                      "format": "decbytes",
                      "logBase": 1,
                      "min": "0",
                      "show": true
                    }
                  ],
                  "yaxis": {
                    "align": false
                  }
                },
                {
                  "gridPos": {
                    "h": 2,
                    "w": 12,
                    "x": 0,
                    "y": 14
                  },
                  "id": 18,
                  "options": {
                    "activeTheme": "read-only",
                    "disableThemePicker": true,
                    "themes": [
                      {
                        "name": "read-only",
                        "styles": [
                          {
                            "props": {
                              "theme": "default"
                            },
                            "type": "basetheme"
                          },
                          {
                            "props": {
                              "url": ""
                            },
                            "type": "bgimage"
                          },
                          {
                            "props": {
                              "url": ""
                            },
                            "type": "url"
                          },
                          {
                            "props": {
                              "text": ".sidemenu {\n  display: none;\n}\n\n[aria-label='Search links'] {\n  display: none;\n}\n\n[aria-label='Cycle view mode'] {\n  display: none;\n}\n\n.page-toolbar > div:first-child {\n  display: none;\n}\n\n[aria-label='Share dashboard or panel'] {\n  display: none;\n}\n\n[aria-label='Mark as favorite'] {\n  display: none;\n}\n\n.panel-header {  pointer-events: none;}\n\n[aria-label='Add panel'] {\n  display: none;\n}\n[aria-label='Dashboard settings'] {\n  display: none;\n}\n[aria-label='Save dashboard'] {\n  display: none;\n}\n"
                            },
                            "type": "style"
                          }
                        ]
                      }
                    ]
                  },
                  "pluginVersion": "0.2.1",
                  "transparent": true,
                  "type": "yesoreyeram-boomtheme-panel"
                }
              ],
              "refresh": false,
              "schemaVersion": 35,
              "style": "dark",
              "tags": [],
              "templating": {
                "list": [
                  {
                    "current": {
                      "selected": false,
                      "text": "prometheus",
                      "value": "prometheus"
                    },
                    "hide": 2,
                    "includeAll": false,
                    "label": "",
                    "multi": false,
                    "name": "Source",
                    "options": [],
                    "query": "prometheus",
                    "queryValue": "",
                    "refresh": 1,
                    "regex": "",
                    "skipUrlSync": false,
                    "type": "datasource"
                  },
                  {
                    "current": {
                      "selected": false,
                      "text": "213577a4-3ac6-47a5-a6fa-ff48d52d1571",
                      "value": "213577a4-3ac6-47a5-a6fa-ff48d52d1571"
                    },
                    "datasource": {
                      "uid": "$Source"
                    },
                    "definition": "label_values(deployment)",
                    "hide": 2,
                    "includeAll": false,
                    "label": "mm_id",
                    "multi": false,
                    "name": "mm_id",
                    "options": [],
                    "query": {
                      "query": "label_values(mm_id)",
                      "refId": "prometheus-mm_id-Variable-Query"
                    },
                    "refresh": 1,
                    "regex": "",
                    "skipUrlSync": false,
                    "sort": 0,
                    "tagValuesQuery": "",
                    "tagsQuery": "",
                    "type": "query",
                    "useTags": false
                  },
                  {
                    "auto": false,
                    "auto_count": 30,
                    "auto_min": "10s",
                    "current": {
                      "selected": false,
                      "text": "2m",
                      "value": "2m"
                    },
                    "hide": 2,
                    "name": "rate_duration",
                    "options": [
                      {
                        "selected": false,
                        "text": "1m",
                        "value": "1m"
                      },
                      {
                        "selected": false,
                        "text": "10m",
                        "value": "10m"
                      },
                      {
                        "selected": false,
                        "text": "30m",
                        "value": "30m"
                      },
                      {
                        "selected": false,
                        "text": "1h",
                        "value": "1h"
                      },
                      {
                        "selected": false,
                        "text": "6h",
                        "value": "6h"
                      },
                      {
                        "selected": false,
                        "text": "12h",
                        "value": "12h"
                      },
                      {
                        "selected": false,
                        "text": "1d",
                        "value": "1d"
                      },
                      {
                        "selected": false,
                        "text": "7d",
                        "value": "7d"
                      },
                      {
                        "selected": false,
                        "text": "14d",
                        "value": "14d"
                      },
                      {
                        "selected": false,
                        "text": "30d",
                        "value": "30d"
                      }
                    ],
                    "query": "1m,10m,30m,1h,6h,12h,1d,7d,14d,30d",
                    "refresh": 2,
                    "skipUrlSync": false,
                    "type": "interval"
                  }
                ]
              },
              "time": {
                "from": "now-30m",
                "to": "now"
              },
              "timepicker": {
                "refresh_intervals": [
                  "5s",
                  "10s",
                  "30s",
                  "1m",
                  "5m",
                  "15m",
                  "30m",
                  "1h",
                  "2h",
                  "1d"
                ],
                "time_options": [
                  "5m",
                  "15m",
                  "1h",
                  "6h",
                  "12h",
                  "24h",
                  "2d",
                  "7d",
                  "30d"
                ]
              },
              "timezone": "",
              "title": "health",
              "uid": "ziv5oWanz",
              "version": 14,
              "weekStart": ""
              }
    }
kind: ConfigMap
metadata:
  labels:
    app: dkube-prometheus-grafana
  name: dkube-grafana-dashboard
  namespace: dkube
---
apiVersion: v1
data:
  grafana.ini: |
    ##################### Grafana Configuration Example #####################
    #
    # Everything has defaults so you only need to uncomment things you want to
    # change
    # possible values : production, development
    ; app_mode = production
    # instance name, defaults to HOSTNAME environment variable value or hostname if HOSTNAME var is empty
    ; instance_name = ${HOSTNAME}
    #################################### Paths ####################################
    [paths]
    # Path to where grafana can store temp files, sessions, and the sqlite3 db (if that is used)
    #
    ;data = /var/lib/grafana
    #
    # Directory where grafana can store logs
    #
    ;logs = /var/log/grafana
    #
    # Directory where grafana will automatically scan and look for plugins
    #
    ;plugins = /var/lib/grafana/plugins
    #
    #################################### Server ####################################
    [server]
    # Protocol (http, https, socket)
    ;protocol = http
    # The ip address to bind to, empty will bind to all interfaces
    ;http_addr =
    # The http port  to use
    ;http_port = 3000
    # The public facing domain name used to access grafana from a browser
    ;domain = localhost
    # Redirect to correct domain if host header does not match domain
    # Prevents DNS rebinding attacks
    ;enforce_domain = false
    # The full public facing url you use in browser, used for redirects and emails
    # If you use reverse proxy and sub path specify full url (with sub path)
    root_url = http://localhost:3000/dkube/grafana
    # Log web requests
    ;router_logging = false
    # the path relative working path
    ;static_root_path = public
    # enable gzip
    enable_gzip = true
    # https certs & key file
    ;cert_file =
    ;cert_key =
    # Unix socket path
    ;socket =
    #################################### Database ####################################
    [database]
    # You can configure the database connection by specifying type, host, name, user and password
    # as seperate properties or as on string using the url propertie.
    # Either "mysql", "postgres" or "sqlite3", it's your choice
    ;type = sqlite3
    ;host = 127.0.0.1:3306
    ;name = grafana
    ;user = root
    # If the password contains # or ; you have to wrap it with trippel quotes. Ex """#password;"""
    ;password =
    # Use either URL or the previous fields to configure the database
    # Example: mysql://user:secret@host:port/database
    ;url =
    # For "postgres" only, either "disable", "require" or "verify-full"
    ;ssl_mode = disable
    # For "sqlite3" only, path relative to data_path setting
    ;path = grafana.db
    # Max conn setting default is 0 (mean not set)
    ;max_idle_conn =
    ;max_open_conn =
    #################################### Session ####################################
    [session]
    # Either "memory", "file", "redis", "mysql", "postgres", default is "file"
    ;provider = file
    # Provider config options
    # memory: not have any config yet
    # file: session dir path, is relative to grafana data_path
    # redis: config like redis server e.g. `addr=127.0.0.1:6379,pool_size=100,db=grafana`
    # mysql: go-sql-driver/mysql dsn config string, e.g. `user:password@tcp(127.0.0.1:3306)/database_name`
    # postgres: user=a password=b host=localhost port=5432 dbname=c sslmode=disable
    ;provider_config = sessions
    # Session cookie name
    ;cookie_name = grafana_sess
    # If you use session in https only, default is false
    ;cookie_secure = false
    # Session life time, default is 86400
    ;session_life_time = 86400
    #################################### Data proxy ###########################
    [dataproxy]
    # This enables data proxy logging, default is false
    ;logging = false
    #################################### Analytics ####################################
    [analytics]
    # Server reporting, sends usage counters to stats.grafana.org every 24 hours.
    # No ip addresses are being tracked, only simple counters to track
    # running instances, dashboard and error counts. It is very helpful to us.
    # Change this option to false to disable reporting.
    ;reporting_enabled = true
    # Set to false to disable all checks to https://grafana.net
    # for new vesions (grafana itself and plugins), check is used
    # in some UI views to notify that grafana or plugin update exists
    # This option does not cause any auto updates, nor send any information
    # only a GET request to http://grafana.com to get latest versions
    ;check_for_updates = true
    # Google Analytics universal tracking code, only enabled if you specify an id here
    ;google_analytics_ua_id =
    #################################### Security ####################################
    [security]
    # default admin user, created on startup
    ;admin_user = admin
    # default admin password, can be changed before first start of grafana,  or in profile settings
    ;admin_password = admin
    # used for signing
    ;secret_key = SW2YcwTIb9zpOOhoPsMm
    # Auto-login remember days
    ;login_remember_days = 7
    ;cookie_username = grafana_user
    ;cookie_remember_name = grafana_remember
    # disable gravatar profile images
    ;disable_gravatar = false
    # data source proxy whitelist (ip_or_domain:port separated by spaces)
    ;data_source_proxy_whitelist =
    [snapshots]
    # snapshot sharing options
    ;external_enabled = true
    ;external_snapshot_url = https://snapshots-origin.raintank.io
    ;external_snapshot_name = Publish to snapshot.raintank.io
    # remove expired snapshot
    ;snapshot_remove_expired = true
    # remove snapshots after 90 days
    ;snapshot_TTL_days = 90
    # allow embadding grafana as iframe
    allow_embedding = true
    #################################### Users ####################################
    [users]
    # disable user signup / registration
    ;allow_sign_up = true
    # Allow non admin users to create organizations
    ;allow_org_create = true
    # Set to true to automatically assign new users to the default organization (id 1)
    ;auto_assign_org = true
    # Default role new users will be automatically assigned (if disabled above is set to true)
    ;auto_assign_org_role = Viewer
    # Background text for the user field on the login page
    ;login_hint = email or username
    # Default UI theme ("dark" or "light")
    default_theme = light
    [auth]
    # Set to true to disable (hide) the login form, useful if you use OAuth, defaults to false
    ;disable_login_form = false
    # Set to true to disable the signout link in the side menu. useful if you use auth.proxy, defaults to false
    ;disable_signout_menu = false
    #################################### Anonymous Auth ##########################
    [auth.anonymous]
    # enable anonymous access
    ;enabled = false
    # specify organization name that should be used for unauthenticated users
    ;org_name = Main Org.
    # specify role for unauthenticated users
    ;org_role = Viewer
    #################################### Github Auth ##########################
    [auth.github]
    ;enabled = false
    ;allow_sign_up = true
    ;client_id = some_id
    ;client_secret = some_secret
    ;scopes = user:email,read:org
    ;auth_url = https://github.com/login/oauth/authorize
    ;token_url = https://github.com/login/oauth/access_token
    ;api_url = https://api.github.com/user
    ;team_ids =
    ;allowed_organizations =
    #################################### Google Auth ##########################
    [auth.google]
    ;enabled = false
    ;allow_sign_up = true
    ;client_id = some_client_id
    ;client_secret = some_client_secret
    ;scopes = https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email
    ;auth_url = https://accounts.google.com/o/oauth2/auth
    ;token_url = https://accounts.google.com/o/oauth2/token
    ;api_url = https://www.googleapis.com/oauth2/v1/userinfo
    ;allowed_domains =
    #################################### Generic OAuth ##########################
    [auth.generic_oauth]
    ;enabled = false
    ;name = OAuth
    ;allow_sign_up = true
    ;client_id = some_id
    ;client_secret = some_secret
    ;scopes = user:email,read:org
    ;auth_url = https://foo.bar/login/oauth/authorize
    ;token_url = https://foo.bar/login/oauth/access_token
    ;api_url = https://foo.bar/user
    ;team_ids =
    ;allowed_organizations =
    #################################### Grafana.com Auth ####################
    [auth.grafana_com]
    ;enabled = false
    ;allow_sign_up = true
    ;client_id = some_id
    ;client_secret = some_secret
    ;scopes = user:email
    ;allowed_organizations =
    #################################### Auth Proxy ##########################
    [auth.proxy]
    ;enabled = false
    ;header_name = X-WEBAUTH-USER
    ;header_property = username
    ;auto_sign_up = true
    ;ldap_sync_ttl = 60
    ;whitelist = 192.168.1.1, 192.168.2.1
    #################################### Basic Auth ##########################
    [auth.basic]
    ;enabled = true
    #################################### Auth LDAP ##########################
    [auth.ldap]
    ;enabled = false
    ;config_file = /etc/grafana/ldap.toml
    ;allow_sign_up = true
    #################################### SMTP / Emailing ##########################
    [smtp]
    ;enabled = false
    ;host = localhost:25
    ;user =
    # If the password contains # or ; you have to wrap it with trippel quotes. Ex """#password;"""
    ;password =
    ;cert_file =
    ;key_file =
    ;skip_verify = false
    ;from_address = admin@grafana.localhost
    ;from_name = Grafana
    [emails]
    ;welcome_email_on_sign_up = false
    #################################### Logging ##########################
    [log]
    # Either "console", "file", "syslog". Default is console and  file
    # Use space to separate multiple modes, e.g. "console file"
    ;mode = console file
    # Either "debug", "info", "warn", "error", "critical", default is "info"
    ;level = info
    # optional settings to set different levels for specific loggers. Ex filters = sqlstore:debug
    ;filters =
    # For "console" mode only
    [log.console]
    ;level =
    # log line format, valid options are text, console and json
    ;format = console
    # For "file" mode only
    [log.file]
    ;level =
    # log line format, valid options are text, console and json
    ;format = text
    # This enables automated log rotate(switch of following options), default is true
    ;log_rotate = true
    # Max line number of single file, default is 1000000
    ;max_lines = 1000000
    # Max size shift of single file, default is 28 means 1 << 28, 256MB
    ;max_size_shift = 28
    # Segment log daily, default is true
    ;daily_rotate = true
    # Expired days of log file(delete after max days), default is 7
    ;max_days = 7
    [log.syslog]
    ;level =
    # log line format, valid options are text, console and json
    ;format = text
    # Syslog network type and address. This can be udp, tcp, or unix. If left blank, the default unix endpoints will be used.
    ;network =
    ;address =
    # Syslog facility. user, daemon and local0 through local7 are valid.
    ;facility =
    # Syslog tag. By default, the process' argv[0] is used.
    ;tag =
    #################################### AMQP Event Publisher ##########################
    [event_publisher]
    ;enabled = false
    ;rabbitmq_url = amqp://localhost/
    ;exchange = grafana_events
    ;#################################### Dashboard JSON files ##########################
    [dashboards.json]
    ;enabled = false
    ;path = /var/lib/grafana/dashboards
    #################################### Alerting ############################
    [alerting]
    # Disable alerting engine & UI features
    ;enabled = true
    # Makes it possible to turn off alert rule execution but alerting UI is visible
    ;execute_alerts = true
    #################################### Internal Grafana Metrics ##########################
    # Metrics available at HTTP API Url /api/metrics
    [metrics]
    # Disable / Enable internal metrics
    ;enabled           = true
    # Publish interval
    ;interval_seconds  = 10
    # Send internal metrics to Graphite
    [metrics.graphite]
    # Enable by setting the address setting (ex localhost:2003)
    ;address =
    ;prefix = prod.grafana.%(instance_name)s.
    #################################### Grafana.com integration  ##########################
    # Url used to to import dashboards directly from Grafana.com
    [grafana_com]
    ;url = https://grafana.com
    #################################### External image storage ##########################
    [external_image_storage]
    # Used for uploading images to public servers so they can be included in slack/email messages.
    # you can choose between (s3, webdav)
    ;provider =
    [external_image_storage.s3]
    ;bucket_url =
    ;access_key =
    ;secret_key =
    [external_image_storage.webdav]
    ;url =
    ;public_url =
    ;username =
    ;password =
kind: ConfigMap
metadata:
  labels:
    app.kubernetes.io/deploy-manager: ksonnet
    ksonnet.io/component: monitoring
  name: dkube-grafana-init
  namespace: dkube
# ---
# apiVersion: v1
# kind: Service
# metadata:
#   annotations:
#     prometheus.io/port: "8080"
#     prometheus.io/dkube_scrape: "true"
#   labels:
#     app: dkube-pod-exporter
#     ksonnet.io/component: monitoring
#   name: dkube-cpu-exporter-service
#   namespace: dkube
# spec:
#   ports:
#   - name: http-metrics
#     port: 8080
#     protocol: TCP
#     targetPort: 8080
#   selector:
#     app: pod-exporter
#   sessionAffinity: None
#   type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: dkube-prometheus-grafana
    ksonnet.io/component: monitoring
  name: dkube-grafana
  namespace: dkube
spec:
  ports:
  - name: http
    port: 80
    protocol: TCP
    targetPort: 3000
  selector:
    app: dkube-prometheus-grafana
  sessionAffinity: None
  type: ClusterIP
# ---
# apiVersion: apps/v1
# kind: DaemonSet
# metadata:
#   labels:
#     ksonnet.io/component: monitoring
#   name: dkube-cpu-exporter
#   namespace: dkube
# spec:
#   selector:
#     matchLabels:
#       app: pod-exporter
#   template:
#     metadata:
#       labels:
#         app: pod-exporter
#     spec:
#       tolerations:
#         - operator: "Exists"
#       containers:
#       - image: google/cadvisor:latest
#         imagePullPolicy: IfNotPresent
#         name: cadvisor
#         ports:
#         - containerPort: 8080
#           name: http-metrics
#           protocol: TCP
#         volumeMounts: cadvVolumeMounts
#       dnsConfig:
#         options:
#         - name: single-request-reopen
#         - name: timeout
#           value: "30"
#       volumes: cadvVolumes
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: dkube-prometheus-grafana
    chart: grafana-0.0.37
    heritage: Tiller
    ksonnet.io/component: monitoring
    release: kube-prometheus
  name: dkube-grafana
  namespace: dkube
spec:
  progressDeadlineSeconds: 600
  replicas: 1
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: dkube-prometheus-grafana
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: dkube-prometheus-grafana
        release: kube-prometheus
    spec:
      containers:
      - env:
        - name: GF_SECURITY_ALLOW_EMBEDDING
          value: "true"
        - name: GF_INSTALL_PLUGINS
          value: "yesoreyeram-boomtheme-panel 0.2.1"
        - name: GF_AUTH_BASIC_ENABLED
          value: "true"
        - name: GF_AUTH_ANONYMOUS_ENABLED
          value: "true"
        - name: GF_SECURITY_ADMIN_USER
          valueFrom:
            secretKeyRef:
              key: user
              name: dkube-prometheus-grafana
        - name: GF_SECURITY_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              key: password
              name: dkube-prometheus-grafana
        image: grafana/grafana:8.4.4
        imagePullPolicy: IfNotPresent
        name: grafana
        ports:
        - containerPort: 3000
          name: web
          protocol: TCP
        readinessProbe:
          failureThreshold: 10
          httpGet:
            path: /api/health
            port: 3000
            scheme: HTTP
          periodSeconds: 1
          successThreshold: 1
          timeoutSeconds: 1
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /var/lib/grafana
          name: grafana-storage
        - mountPath: /etc/grafana/grafana.ini
          name: grafana-config
          subPath: grafana.ini
      - args:
        - --watch-dir=/var/grafana-dashboards
        - --grafana-url=http://127.0.0.1:3000
        env:
        - name: GRAFANA_USER
          valueFrom:
            secretKeyRef:
              key: user
              name: dkube-prometheus-grafana
        - name: GRAFANA_PASSWORD
          valueFrom:
            secretKeyRef:
              key: password
              name: dkube-prometheus-grafana
        image: quay.io/coreos/grafana-watcher:v0.0.8
        imagePullPolicy: IfNotPresent
        name: grafana-watcher
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /var/grafana-dashboards
          name: grafana-dashboards
      dnsConfig:
        options:
        - name: single-request-reopen
        - name: timeout
          value: "30"
      dnsPolicy: ClusterFirst
      nodeSelector: NODE_SELECTOR
      restartPolicy: Always
      schedulerName: default-scheduler
      serviceAccount: dkube-prometheus
      serviceAccountName: dkube-prometheus
      terminationGracePeriodSeconds: 30
      volumes:
      - name: grafana-storage
      - configMap:
          defaultMode: 420
          name: dkube-grafana-dashboard
        name: grafana-dashboards
      - configMap:
          defaultMode: 420
          name: dkube-grafana-init
        name: grafana-config
