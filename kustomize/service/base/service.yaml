---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    ksonnet.io/component: service
  name: dex
rules:
- apiGroups:
  - dex.coreos.com
  resources:
  - '*'
  verbs:
  - '*'
- apiGroups:
  - apiextensions.k8s.io
  resources:
  - customresourcedefinitions
  verbs:
  - create
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  labels:
    ksonnet.io/component: service
  name: dex
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: dex
subjects:
- kind: ServiceAccount
  name: dkube
  namespace: dkube
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  labels:
    ksonnet.io/component: service
  name: dkube
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: dkubeClusterRole
subjects:
- kind: ServiceAccount
  name: dkube
  namespace: dkube
---
apiVersion: v1
data:
  config.yaml: |
    issuer: http://localhost:5556/dex
    storage:
      type: kubernetes
      config:
        inCluster: true
    frontend:
      logoURL: "/dex"
      extra:
        dkubeUrl: "/dex/theme/logo.png"
        favUrl: "/dex/theme/favicon.png"
        mainCss: "/dex/static/main.css"
        styleCss: "/dex/theme/styles.css"
    web:
      http: 0.0.0.0:5556
    telemetry:
      http: 0.0.0.0:5558
    expiry:
      idTokens: "72h"
      signingKeys: "72h"
    staticClients:
    - id: dkube
      redirectURIs:
      - '/callback'
      name: 'Dkube App'
      secret: dkube-secret
    oauth2:
      skipApprovalScreen: true
    enablePasswordDB: true
    staticPasswords:
    - email: L-UNAME
      hash: L-PASSWD
      username: L-UNAME
      userID: L-UNAME

kind: ConfigMap
metadata:
  labels:
    ksonnet.io/component: service
  name: dkube-auth-config
  namespace: dkube
---
apiVersion: v1
data:
  fluent.conf: |
    <source>
     @type tail
     path /var/log/containers/*.log
     pos_file /var/log/fluentd-containers-jobs.log.pos
     time_key time
     time_format %Y-%m-%dT%H:%M:%S
     refresh_interval 1s
     open_on_every_update true
     enable_stat_watcher false
     rotate_wait 2
     tag kubernetes_jobs.*
     format json
     read_from_head true
    </source>

    <filter kubernetes_jobs.**>
       @type kubernetes_metadata
    </filter>

    #collecting logs... pod which has labels like logger: dkube (or) logger:dkubepl
    <filter kubernetes_jobs.**>
       @type grep
       <regexp>
          key $.kubernetes.labels.logger
          pattern /^dkube/
       </regexp>
    </filter>

    <filter kubernetes_jobs.**>
        @type record_modifier
        enable_ruby
        <record>
          plpath pllauncher
          training_path jobs
          #check for training job or pipeline  launcher 
          jobuuid ${record.dig("kubernetes", "labels", "jobuuid") ? record.dig("kubernetes", "labels", "jobuuid") : record.dig("kubernetes", "labels", "runid") }
          #check for trail job
          studyuuid ${record.dig("kubernetes", "labels", "studyuuid")}

          finalid ${record.dig("studyuuid") ? record.dig("studyuuid") : record.dig("jobuuid") }

          #pipeline logs are stroing inside logs/pllauncher and training job logs are stroing inside logs/jobs
          fpath ${record.dig("kubernetes", "labels", "runid")? record.dig("plpath") : record.dig("training_path")}

          username ${record.dig("kubernetes", "labels", "username") ? record.dig("kubernetes", "labels", "username") : record.dig("kubernetes", "labels", "workflows_argoproj_io/workflow") }

          container ${record.dig("kubernetes", "container_name")}

          #td-replica-type and tf-replica-index are useful in Distributed job
          temp_log ${record.dig("kubernetes", "labels", "tf-replica-type")}-${record.dig("kubernetes", "labels", "tf-replica-index")}:  ${record.dig("log")}
        
          #check for datajob log or training job log
          training_log ${record.dig("kubernetes", "labels", "tf-replica-type") ? record.dig("temp_log") : record.dig("log")}


          #for trail jobs logs appending trailjobname to logs
          trial_log ${record.dig("kubernetes", "labels", "jobname")}:  ${record.dig("training_log")}

          #pod which has studyuuid label considering as trail job
          final_log ${record.dig("kubernetes", "labels", "studyuuid") ? record.dig("trial_log") : record.dig("training_log")} 

          #for pipeline launcher logs we are not adding extra fields 
          message ${record.dig("kubernetes", "labels", "runid") ? record.dig("log") : record.dig("final_log") } 
        </record>
        #removing unwanted and temp fields
        remove_keys log, stream, docker, kubernetes, final_log, trial_log, training_log, jobuuid, studyuuid, plpath, training_path, temp_log
    </filter>

    <match kubernetes_jobs.**>
       @type s3
       aws_key_id dkube
       aws_sec_key l06dands19s
       s3_endpoint http://dkube-minio-server.dkube:9000/
       s3_bucket dkube
       path system/logs/${fpath}/${username}/${finalid}/${container}
       s3_object_key_format %{path}/job-log-%{index}.%{file_extension}
       store_as text
       force_path_style true
       <format>
         @type single_value
         message_key message
         add_newline false
       </format>
       <buffer username, finalid, container, fpath>
         @type file
         path /var/log/td-agent/jobs/${fpath}/${username}/${finalid}/${container}
         timekey 10s           
         timekey_wait 10s  
         timekey_use_utc true  
         chunk_limit_size 256m
         flush_thread_count 8
         retry_forever true
         overflow_action throw_exception
         retry_type exponential_backoff
         retry_exponential_backoff_base 2
         flush_mode immediate
         flush_at_shutdown true
         queue_limit_length 10000
       </buffer>
    </match>
kind: ConfigMap
metadata:
  name: dkube-log-collector
  namespace: dkube
---
apiVersion: v1
data:
  accuracy.conf: "<filter kubernetes_accuracy.**>\n    @type kubernetes_metadata\n</filter>\n\n<filter
    kubernetes_accuracy.**>\n    @type grep\n    <regexp>\n        key $.kubernetes.labels.logger\n
    \       pattern /^dkube$/\n    </regexp>\n</filter>\n\n<filter kubernetes_accuracy.**>\n
    \   @type grep\n    <regexp>\n        key log\n        pattern /accuracy/\n    </regexp>\n</filter>\n\n<filter
    kubernetes_accuracy.**>\n  @type parser\n  key_name $.log\n  reserve_data true\n
    \ remove_key_name_field true\n  suppress_parse_error_log true\n  <parse>\n    @type
    regexp\n    expression /^(.*):(.*):((.*)])?((.*):)?(?<message>(.*))$/\n  </parse>\n</filter>\n\n
    <filter kubernetes_accuracy.**>\n   @type record_modifier\n   enable_ruby\n   <record>\n
    \      escaped_tag ${record[\"message\"].gsub(' ', '')}\n   </record>\n </filter>\n\n<filter
    kubernetes_accuracy.**>\n    @type grep\n    <regexp>\n        key escaped_tag\n
    \       pattern /accuracy=/\n    </regexp>\n</filter>\n\n<filter kubernetes_accuracy.**>\n
    \ @type parser\n  key_name $.escaped_tag\n  reserve_data true\n  remove_key_name_field
    true\n  suppress_parse_error_log true\n  <parse>\n    @type ltsv\n    delimiter_pattern
    /,/\n    label_delimiter  =\n  </parse>\n</filter>\n\n<filter kubernetes_accuracy.**>\n
    \  @type record_modifier\n   enable_ruby\n   <record>\n       jobname ${record.dig(\"kubernetes\",
    \"labels\", \"jobname\")}\n       username ${record.dig(\"kubernetes\", \"labels\",
    \"username\")}\n       jobid ${record.dig(\"kubernetes\", \"labels\", \"jobid\")}\n
    \      mode ${record.dig(\"mode\").to_s}\n       step ${record.dig(\"step\").to_i}\n
    \      epoch ${record.dig(\"epoch\").to_i}\n       accuracy ${record.dig(\"accuracy\").to_f}
    \n   </record>\n</filter>\n\n<filter kubernetes_accuracy.**>\n  @type prometheus\n
    \ <metric>\n    name accuracy\n    type gauge\n    desc accuracy metric\n    key
    $.accuracy\n    <labels>\n      jobname ${jobname}\n      username ${username}\n
    \     jobid ${jobid}\n      step ${step}\n      mode ${mode}\n      epoch ${epoch}\n
    \   </labels>\n  </metric>\n</filter>\n\n<match kubernetes_accuracy.**>\n    @type
    relabel\n    @label @PROMETHEUS\n</match>\n"
  fluent.conf: |
    <source>
      @type prometheus
    </source>

    <source>
      @type monitor_agent
    </source>

    <source>
      @type forward
    </source>

    # input plugin that collects metrics from MonitorAgent
    <source>
      @type prometheus_monitor
      <labels>
        host ${hostname}
      </labels>
    </source>

    # input plugin that collects metrics for output plugin
    <source>
      @type prometheus_output_monitor
      <labels>
        host ${hostname}
      </labels>
    </source>

    # input plugin that collects metrics for in_tail plugin
    <source>
      @type prometheus_tail_monitor
      <labels>
        host ${hostname}
      </labels>
    </source>

    <source>
      @type tail
      path /var/log/containers/*_tensorflow-*.log
      pos_file /var/log/fluentd-containers-accuracy.log.pos
      time_format %Y-%m-%dT%H:%M:%S
      tag kubernetes_accuracy.*
      @label @ACCURACY
      format json
      read_from_head true
    </source>

    <source>
      @type tail
      path /var/log/containers/*_tensorflow-*.log
      pos_file /var/log/fluentd-containers-loss.log.pos
      time_format %Y-%m-%dT%H:%M:%S
      tag kubernetes_loss.*
      @label @LOSS
      format json
      read_from_head true
    </source>

    <source>
      @type tail
      path /var/log/containers/*_tensorflow-*.log
      pos_file /var/log/fluentd-containers-step.log.pos
      time_format %Y-%m-%dT%H:%M:%S
      tag kubernetes_step.*
      @label @STEP
      format json
      read_from_head true
    </source>

    <label @STEP>
        @include step.conf
    </label>

    <label @ACCURACY>
        @include accuracy.conf
    </label>

    <label @LOSS>
        @include loss.conf
    </label>

    <label @PROMETHEUS>
        @include prometheus.conf
    </label>
  loss.conf: "<filter kubernetes_loss.**>\n     @type kubernetes_metadata\n </filter>\n\n
    <filter kubernetes_loss.**>\n     @type grep\n     <regexp>\n         key $.kubernetes.labels.logger\n
    \        pattern /^dkube$/\n     </regexp>\n </filter>\n\n <filter kubernetes_loss.**>\n
    \    @type grep\n     <regexp>\n         key log\n         pattern /loss/\n     </regexp>\n
    </filter>\n\n <filter kubernetes_loss.**>\n   @type parser\n   key_name $.log\n
    \  reserve_data true\n   remove_key_name_field true\n   suppress_parse_error_log
    true\n   <parse>\n     @type regexp\n     expression /^(.*):(.*):((.*)])?((.*):)?(?<message>(.*))$/\n
    \  </parse>\n </filter>\n\n  <filter kubernetes_loss.**>\n    @type record_modifier\n
    \   enable_ruby\n    <record>\n        escaped_tag ${record[\"message\"].gsub('
    ', '')}\n    </record>\n  </filter>\n\n <filter kubernetes_loss.**>\n     @type
    grep\n     <regexp>\n         key escaped_tag\n         pattern /loss=/\n     </regexp>\n
    </filter>\n\n <filter kubernetes_loss.**>\n   @type parser\n   key_name $.escaped_tag\n
    \  reserve_data true\n   remove_key_name_field true\n   suppress_parse_error_log
    true\n   <parse>\n     @type ltsv\n     delimiter_pattern /,/\n     label_delimiter
    \ =\n   </parse>\n </filter>\n\n <filter kubernetes_loss.**>\n    @type record_modifier\n
    \   enable_ruby\n    <record>\n        jobname ${record.dig(\"kubernetes\", \"labels\",
    \"jobname\")}\n        username ${record.dig(\"kubernetes\", \"labels\", \"username\")}\n
    \       jobuuid ${record.dig(\"kubernetes\", \"labels\", \"jobuuid\")}\n        jobid
    ${record.dig(\"kubernetes\", \"labels\", \"jobid\")}\n        step ${record.dig(\"step\").to_i}\n
    \       loss ${record.dig(\"loss\").to_f}\n        mode ${record.dig(\"mode\").to_s}\n
    \       epoch ${record.dig(\"epoch\").to_i} \n    </record>\n </filter>\n\n <filter
    kubernetes_loss.**>\n   @type prometheus\n   <metric>\n     name loss\n     type
    gauge\n     desc loss metric\n     key $.loss\n     <labels>\n       jobuuid ${jobuuid}\n
    \      jobname ${jobname}\n       username ${username}\n       jobid ${jobid}\n
    \      step ${step}\n       mode ${mode}\n       epoch ${epoch}\n     </labels>\n
    \  </metric>\n </filter>\n\n <match kubernetes_loss.**>\n     @type relabel\n
    \    @label @PROMETHEUS\n </match>\n"
  prometheus.conf: |
    <match {kubernetes_accuracy.**, kubernetes_loss.**, kubernetes_step.**}>
      @type copy
      # for MonitorAgent sample
      <store>
        @id test_forward
        @type forward
        buffer_type memory
        flush_interval 1s
        max_retry_wait 2s
        send_timeout 60s
        recover_wait 60s
        hard_timeout 60s
        <buffer>
          # max_retry_wait 10s
          flush_interval 1s
          # retry_type periodic
          disable_retry_limit
       </buffer>
       # retry_limit 3
       disable_retry_limit
       <server>
         host 0.0.0.0
         port 24224
       </server>
      </store>
    </match>
  step.conf: |
    <filter kubernetes_step.**>
        @type kubernetes_metadata
    </filter>

    <filter kubernetes_step.**>
        @type grep
        <regexp>
            key $.kubernetes.labels.logger
            pattern /^dkube$/
        </regexp>
    </filter>

    <filter kubernetes_step.**>
        @type grep
        <regexp>
            key log
            pattern /step/
        </regexp>
    </filter>

    <filter kubernetes_step.**>
      @type parser
      key_name $.log
      reserve_data true
      remove_key_name_field true
      suppress_parse_error_log true
      <parse>
        @type regexp
        expression /^(.*):(.*):((.*)])?((.*):)?(?<message>(.*))$/
      </parse>
    </filter>

     <filter kubernetes_step.**>
       @type record_modifier
       enable_ruby
       <record>
           escaped_tag ${record["message"].gsub(' ', '')}
       </record>
     </filter>

    <filter kubernetes_step.**>
        @type grep
        <regexp>
            key escaped_tag
            pattern /,step=/
        </regexp>
    </filter>

    <filter kubernetes_step.**>
      @type parser
      key_name $.escaped_tag
      reserve_data true
      remove_key_name_field true
      suppress_parse_error_log true
      <parse>
        @type ltsv
        delimiter_pattern /,/
        label_delimiter  =
      </parse>
    </filter>

    <filter kubernetes_step.**>
       @type record_modifier
       enable_ruby
       <record>
           jobname ${record.dig("kubernetes", "labels", "jobname")}
           username ${record.dig("kubernetes", "labels", "username")}
           jobid ${record.dig("kubernetes", "labels", "jobid")}
           step ${record.dig("step").to_i}
           accuracy ${record.dig("accuracy").to_f}
           loss ${record.dig("loss").to_f}
           mode ${record.dig("mode").to_s}
       </record>
    </filter>

    <filter kubernetes_step.**>
      @type prometheus
      <metric>
        name step
        type gauge
        desc step metric
        key $.step
        <labels>
          jobname ${jobname}
          username ${username}
          jobid ${jobid}
          accuracy ${accuracy}
          loss ${loss}
          mode ${mode}
        </labels>
      </metric>
    </filter>

    <match kubernetes_step.**>
        @type relabel
        @label @PROMETHEUS
    </match>
kind: ConfigMap
metadata:
  labels:
    ksonnet.io/component: service
  name: dkube-metric-collector
  namespace: dkube
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  labels:
    ksonnet.io/component: service
  name: dkube-db-pvc
  namespace: dkube
spec:
  accessModes:
  - ReadWriteMany
  resources:
    requests:
      storage: 50Gi
  storageClassName: ""
  volumeName: dkube-db-pv
---
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    ksonnet.io/component: service
  name: dkube
  namespace: dkube
---
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    ksonnet.io/component: service
  name: dkube-proxy
  namespace: dkube
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: Role
metadata:
  labels:
    ksonnet.io/component: service
  name: dkube-proxy
  namespace: dkube
rules:
- apiGroups:
  - ""
  resources:
  - services
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - ""
  resources:
  - configmaps
  verbs:
  - create
  - update
  - patch
  - get
  - list
  - watch
- apiGroups:
  - ""
  resources:
  - secrets
  verbs:
  - get
  - list
  - watch
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: RoleBinding
metadata:
  labels:
    ksonnet.io/component: service
  name: dkube-proxy
  namespace: dkube
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: dkube-proxy
subjects:
- kind: ServiceAccount
  name: dkube-proxy
  namespace: dkube
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: d3auth
    ksonnet.io/component: service
  name: dkube-auth-server
  namespace: dkube
spec:
  ports:
  - name: dex-s
    port: 5556
    protocol: TCP
    targetPort: 5556
  - name: authn
    port: 3001
    protocol: TCP
    targetPort: 3001
  selector:
    app: dkube-auth
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: dkube-controller-master
    ksonnet.io/component: service
  name: dkube-controller-headless-master
  namespace: dkube
spec:
  clusterIP: None
  ports:
  - name: dkube-d3api
    port: 5000
    protocol: TCP
    targetPort: 5000
  selector:
    app: dkube-controller-master
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: dkube-controller-master
    ksonnet.io/component: service
  name: dkube-controller-master
  namespace: dkube
spec:
  ports:
  - name: dkube-d3api
    port: 5000
    protocol: TCP
    targetPort: 5000
  - name: dkube-d3pl
    port: 5001
    protocol: TCP
    targetPort: 5001
  - name: dkube-d3mlflow
    port: 5002
    protocol: TCP
    targetPort: 5002
  selector:
    app: dkube-controller-master
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: dkube-controller-worker
    ksonnet.io/component: service
  name: dkube-controller-worker
  namespace: dkube
spec:
  ports:
  - port: 5000
    protocol: TCP
    targetPort: 5000
  selector:
    app: dkube-controller-worker
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: dkube-db-server
  namespace: dkube
spec:
  ports:
  - port: 2379
    protocol: TCP
    targetPort: 2379
  selector:
    app: dkube-db-server
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: dkube-docs
  namespace: dkube
spec:
  ports:
  - name: serve
    port: 8888
    protocol: TCP
    targetPort: 80
  selector:
    app: dkube-tools
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: dkube-downloader
  namespace: dkube
spec:
  ports:
  - port: 9401
    protocol: TCP
    targetPort: 9401
  selector:
    app: dkube-controller-worker
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    prometheus.io/port: "9401"
    prometheus.io/dkube_scrape: "true"
  labels:
    app: dkube-gpu-exporter
    ksonnet.io/component: service
  name: dkube-exporter
  namespace: dkube
spec:
  ports:
  - name: http-metrics
    port: 9401
    protocol: TCP
    targetPort: 9401
  selector:
    app: dkube-ext
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    prometheus.io/port: "24231"
    prometheus.io/dkube_scrape: "true"
  labels:
    app: dkube-log-processor
    ksonnet.io/component: service
  name: dkube-log-processor
  namespace: dkube
spec:
  ports:
  - name: dkube-log-metrics
    port: 24231
    protocol: TCP
    targetPort: 24231
  selector:
    k8s-app: dkube-metric-collector
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: dkube-operator-api-proxy
  namespace: dkube
spec:
  ports:
  - name: dfabproxy
    port: 8000
    protocol: TCP
    targetPort: 8000
  selector:
    app: dkube-operator-proxy
  sessionAffinity: None
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: dkube-prometheus-grafana
    ksonnet.io/component: service
  name: dkube-prometheus-grafana-proxy
  namespace: dkube
spec:
  ports:
  - name: http
    port: 80
    protocol: TCP
    targetPort: 3000
  selector:
    app: dkube-prometheus-grafana
  sessionAffinity: None
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: dkube-serving
  namespace: dkube
spec:
  ports:
  - name: serve
    port: 8000
    protocol: TCP
    targetPort: 8000
  selector:
    app: dkube-tools
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    prometheus.io/port: "9401"
    prometheus.io/dkube_scrape: "true"
  labels:
    app: dkube-storage-exporter
    ksonnet.io/component: service
  name: dkube-storage-exporter
  namespace: dkube
spec:
  ports:
  - name: http-metrics
    port: 9401
    protocol: TCP
    targetPort: 9401
  selector:
    app: dkube-storage-exporter
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    ksonnet.io/component: service
    service: dkube-ui
  name: dkube-ui
  namespace: dkube
spec:
  ports:
  - name: ui
    port: 3000
    targetPort: 3000
  selector:
    app: dkube-ui
  type: ClusterIP
---
apiVersion: authentication.istio.io/v1alpha1
kind: MeshPolicy
metadata:
  labels:
    app: security
    chart: security
    heritage: Tiller
    release: istio
  name: default
spec:
  originIsOptional: false
  origins:
  - jwt:
      issuer: http://localhost:5556/dex
      jwksUri: http://dkube-auth-server.dkube.svc.cluster.local:5556/dex/keys
      triggerRules:
      - excludedPaths:
        - exact: /
        - prefix: /dex
        - prefix: /pipeline
        - prefix: /dkube/pipeline
        - prefix: /static
        - prefix: /callback
        - prefix: /favicon
        - prefix: /dkube/v2/login
        - prefix: /dkube/v2/logout
        - prefix: /dkube/v2/ext
        - prefix: /dkube/v2/etcd
        - prefix: /dkube/v2/prometheus
        - prefix: /dkube/v2/controller/dlsupport
        - prefix: /dkube/v2/controller/notify
        - prefix: /dkube/v2/controller/init
        - prefix: /dkube/v2/controller/dkubeinfo
        - prefix: /cicd
        - suffix: /custom
        - prefix: /v1/models/
        - regex: .*/nb/.*|.*/nb/lab.*|.*/tb/.*|.*/inference|.*/font-roboto/.*|.*/installer|.*/report|.*/katib.*|.*/rs.*|.*/docs/.*|.*/healthz
  - jwt:
      issuer: DKube
      jwksUri: http://dkube-auth-server.dkube.svc.cluster.local:3001/keys
      triggerRules:
      - excludedPaths:
        - exact: /
        - prefix: /dex
        - prefix: /pipeline
        - prefix: /dkube/pipeline
        - prefix: /static
        - prefix: /callback
        - prefix: /favicon
        - prefix: /dkube/v2/login
        - prefix: /dkube/v2/logout
        - prefix: /dkube/v2/ext
        - prefix: /dkube/v2/etcd
        - prefix: /dkube/v2/prometheus
        - prefix: /dkube/v2/controller/dlsupport
        - prefix: /dkube/v2/controller/notify
        - prefix: /dkube/v2/controller/init
        - prefix: /dkube/v2/controller/dkubeinfo
        - prefix: /cicd
        - suffix: /custom
        - prefix: /v1/models/
        - regex: .*/nb/.*|.*/nb/lab.*|.*/tb/.*|.*/inference|.*/font-roboto/.*|.*/installer|.*/report|.*/katib.*|.*/rs.*|.*/docs/.*|.*/healthz
  principalBinding: USE_ORIGIN
---
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: dkube-authn
  namespace: dkube
spec:
  filters:
  - filterConfig:
      httpService:
        authorizationRequest:
          allowedHeaders:
            patterns:
            - exact: cookie
            - exact: mode
            - exact: d3-license
            - exact: d3-uname
            - exact: d3-role
        authorizationResponse:
          allowedUpstreamHeaders:
            patterns:
            - exact: kubeflow-userid
            - exact: mode
            - exact: d3-license
            - exact: d3-uname
            - exact: d3-role
        serverUri:
          cluster: outbound|3001||dkube-auth-server.dkube.svc.cluster.local
          failureModeAllow: false
          timeout: 10s
          uri: http://dkube-auth-server.dkube.svc.cluster.local
      statusOnError:
        code: GatewayTimeout
    filterName: envoy.ext_authz
    filterType: HTTP
    insertPosition:
      index: FIRST
    listenerMatch:
      listenerType: GATEWAY
  workloadLabels:
    dkube: ingressgateway
---
apiVersion: v1
kind: Service
metadata:
  name: dkube-proxy
  namespace: dkube
  labels:
    dkube: ingressgateway
spec:
  type: NodePort
  selector:
    dkube: ingressgateway
  ports:
    -
      name: https
      nodePort: 32222
      port: 443
---
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: dkube-istio-gateway
  namespace: dkube
spec:
  selector:
    dkube: ingressgateway
  servers:
  - port:
      number: 443
      name: https
      protocol: HTTPS
    tls:
      mode: SIMPLE
      serverCertificate: /etc/istio/ingressgateway-certs/tls.crt
      privateKey: /etc/istio/ingressgateway-certs/tls.key
    hosts:
    - "*"
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: dkube-auth-server
  namespace: dkube
spec:
  hosts:
  - "*"
  gateways:
  - dkube-istio-gateway
  http:
  - match:
    - uri:
        prefix: /dex
    route:
    - destination:
        port:
          number: 5556
        host: dkube-auth-server
    retries:
      attempts: 3
      perTryTimeout: 5s
      retryOn: gateway-error,connect-failure,refused-stream
  - match:
    - uri:
        prefix: /dkube/v2/login
    rewrite:
        uri: /login
    route:
    - destination:
        port:
          number: 3001
        host: dkube-auth-server
    retries:
      attempts: 3
      perTryTimeout: 5s
      retryOn: gateway-error,connect-failure,refused-stream
  - match:
    - uri:
        prefix: /dkube/v2/logout
    rewrite:
        uri: /logout
    route:
    - destination:
        port:
          number: 3001
        host: dkube-auth-server
    retries:
      attempts: 3
      perTryTimeout: 5s
      retryOn: gateway-error,connect-failure,refused-stream
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: dkube-db-server
  namespace: dkube
spec:
  hosts:
  - "*"
  gateways:
  - dkube-istio-gateway
  http:
  - match:
    - uri:
        prefix: /dkube/v2/etcd/
    rewrite:
        uri: /
    route:
    - destination:
        port:
          number: 2379
        host: dkube-db-server
    retries:
      attempts: 3
      perTryTimeout: 5s
      retryOn: gateway-error,connect-failure,refused-stream
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: dkube-docs
  namespace: dkube
spec:
  hosts:
  - "*"
  gateways:
  - dkube-istio-gateway
  http:
  - match:
    - uri:
        prefix: /docs
    rewrite:
        uri: /docs
    route:
    - destination:
        port:
          number: 8888
        host: dkube-docs
    retries:
      attempts: 3
      perTryTimeout: 5s
      retryOn: gateway-error,connect-failure,refused-stream
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: dkube-downloader
  namespace: dkube
spec:
  hosts:
  - "*"
  gateways:
  - dkube-istio-gateway
  http:
  - match:
    - uri:
        prefix: /dkube/v2/ext
    rewrite:
        uri: /dkube/v2
    route:
    - destination:
        port:
          number: 9401
        host: dkube-downloader
    retries:
      attempts: 3
      perTryTimeout: 5s
      retryOn: gateway-error,connect-failure,refused-stream
  - match:
    - uri:
        prefix: /dkube/pipeline/logs/
    rewrite:
        uri: /dkube/v2/kubeflow/
    route:
    - destination:
        port:
          number: 9401
        host: dkube-downloader
    retries:
      attempts: 3
      perTryTimeout: 5s
      retryOn: gateway-error,connect-failure,refused-stream
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: dkube-operator-api-proxy
  namespace: dkube
spec:
  hosts:
  - "*"
  gateways:
  - dkube-istio-gateway
  http:
  - match:
    - uri:
        prefix: /dkube/v2/operator
    route:
    - destination:
        port:
          number: 8000
        host: dkube-operator-api-proxy
    retries:
      attempts: 3
      perTryTimeout: 5s
      retryOn: gateway-error,connect-failure,refused-stream
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: dkube-prometheus-grafana
  namespace: dkube
spec:
  hosts:
  - "*"
  gateways:
  - dkube-istio-gateway
  http:
  - match:
    - uri:
        prefix: /dkube/grafana/
    rewrite:
        uri: /
    route:
    - destination:
        port:
          number: 80
        host: dkube-grafana
    retries:
      attempts: 3
      perTryTimeout: 5s
      retryOn: gateway-error,connect-failure,refused-stream
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: dkube-prometheus
  namespace: dkube
spec:
  hosts:
  - "*"
  gateways:
  - dkube-istio-gateway
  http:
  - match:
    - uri:
        prefix: /dkube/v2/prometheus/api/v1
    rewrite:
        uri: /api/v1
    route:
    - destination:
        port:
          number: 9090
        host: dkube-prometheus.dkube.svc.cluster.local
    retries:
      attempts: 3
      perTryTimeout: 5s
      retryOn: gateway-error,connect-failure,refused-stream
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: dkube-serving
  namespace: dkube
spec:
  hosts:
  - "*"
  gateways:
  - dkube-istio-gateway
  http:
  - match:
    - uri:
        prefix: /inference
    route:
    - destination:
        port:
          number: 8000
        host: dkube-serving
    retries:
      attempts: 3
      perTryTimeout: 5s
      retryOn: gateway-error,connect-failure,refused-stream
  - match:
    - uri:
        prefix: /predict
    route:
    - destination:
        port:
          number: 8000
        host: dkube-serving
    retries:
      attempts: 3
      perTryTimeout: 5s
      retryOn: gateway-error,connect-failure,refused-stream
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: dkube-ui
  namespace: dkube
spec:
  hosts:
  - "*"
  gateways:
  - dkube-istio-gateway
  http:
  - match:
    - uri:
        prefix: /
    route:
    - destination:
        port:
          number: 3000
        host: dkube-ui
    retries:
      attempts: 3
      perTryTimeout: 5s
      retryOn: gateway-error,connect-failure,refused-stream
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: kf-argo-ui
  namespace: dkube
spec:
  hosts:
  - "*"
  gateways:
  - dkube-istio-gateway
  http:
  - match:
    - uri:
        prefix: /argo/logs/
    rewrite:
        uri: /api/logs/
    route:
    - destination:
        port:
          number: 80
        host: argo-ui.kubeflow.svc.cluster.local
    retries:
      attempts: 3
      perTryTimeout: 5s
      retryOn: gateway-error,connect-failure,refused-stream
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: kf-katib
  namespace: dkube
spec:
  hosts:
  - "*"
  gateways:
  - dkube-istio-gateway
  http:
  - match:
    - uri:
        prefix: /katib
    route:
    - destination:
        port:
          number: 80
        host: katib-ui.kubeflow.svc.cluster.local
    retries:
      attempts: 3
      perTryTimeout: 5s
      retryOn: gateway-error,connect-failure,refused-stream
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: kf-pipeline-ui
  namespace: dkube
spec:
  hosts:
  - "*"
  gateways:
  - dkube-istio-gateway
  http:
  - match:
    - method:
        regex: POST|DELETE
      uri:
        prefix: /pipeline/apis/v1beta1/experiments
    route:
    - destination:
        host: dkube-controller-master
        port:
          number: 5001
    retries:
      attempts: 3
      perTryTimeout: 5s
      retryOn: gateway-error,connect-failure,refused-stream
  - match:
    - method:
        regex: POST|DELETE
      uri:
        prefix: /pipeline/apis/v1beta1/pipeline
    route:
    - destination:
        host: dkube-controller-master
        port:
          number: 5001
    retries:
      attempts: 3
      perTryTimeout: 5s
      retryOn: gateway-error,connect-failure,refused-stream
  - match:
    - method:
        regex: POST|DELETE
      uri:
        prefix: /pipeline/apis/v1beta1/runs
    route:
    - destination:
        host: dkube-controller-master
        port:
          number: 5001
    retries:
      attempts: 3
      perTryTimeout: 5s
      retryOn: gateway-error,connect-failure,refused-stream
  - match:
    - uri:
        prefix: /pipeline
    route:
    - destination:
        host: ml-pipeline-ui.kubeflow.svc.cluster.local
        port:
          number: 80
    retries:
      attempts: 3
      perTryTimeout: 5s
      retryOn: gateway-error,connect-failure,refused-stream
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: dkube-installer
  namespace: dkube
spec:
  hosts:
  - "*"
  gateways:
  - dkube-istio-gateway
  http:
  - match:
    - uri:
        prefix: /installer
    rewrite:
        uri: /ui
    route:
    - destination:
        port:
          number: 8888
        host: dkube-installer-service
    retries:
      attempts: 3
      perTryTimeout: 5s
      retryOn: gateway-error,connect-failure,refused-stream
  - match:
    - uri:
        prefix: /report
    route:
    - destination:
        port:
          number: 8888
        host: dkube-installer-service
    retries:
      attempts: 3
      perTryTimeout: 5s
      retryOn: gateway-error,connect-failure,refused-stream
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: dkube-controller
  namespace: dkube
spec:
  hosts:
  - "*"
  gateways:
  - dkube-istio-gateway
  http:
  - match:
    - uri:
        prefix: /dkube/v2/controller
      method:
        exact: GET
    route:
    - destination:
        port:
          number: 5000
        host: dkube-controller-worker
    retries:
      attempts: 3
      perTryTimeout: 5s
      retryOn: gateway-error,connect-failure,refused-stream
  - match:
    - uri:
        prefix: /dkube/v2/controller
    route:
    - destination:
        port:
          number: 5000
        host: dkube-controller-master
    retries:
      attempts: 3
      perTryTimeout: 5s
      retryOn: gateway-error,connect-failure,refused-stream
---
apiVersion: v1
kind: Service
metadata:
  name: dkube-minio-server
  namespace: dkube
spec:
  externalName: dkube-minio-server.dkube-infra.svc.cluster.local
  type: ExternalName
